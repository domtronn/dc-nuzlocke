<html>
  <head>
    <script>
     const target = 'https://nuzlocke.app'
     const log = msg => console.log(`[cdls] ${msg}`)

     const messageHandler = event => {
       if (event.origin !== target)
         return log(`Invalid event origin: ${event.origin}`)

       const { action } = event.data
       const storage = window.localStorage
       const filtered = Object.fromEntries(
         Object
           .entries(storage)
           .filter(([key]) => key.startsWith('nuzlocke'))
       )

       log(`Iframe message received: ${action}`)

       if (action === 'cdls_get') {
         event.source.postMessage({
           action: 'cdls_data',
           data: filtered
         }, target)
       }
     }

     log(`Iframe mounted - Posting ready message`)
     window.addEventListener('message', messageHandler, false)
     top.postMessage({ action: 'cdls_ready' }, target)
    </script>
  </head>
  <body></body>
</html>
