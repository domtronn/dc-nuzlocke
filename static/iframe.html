<html>
  <head>
    <script>
     const log = msg => console.log(`[cdls] ${msg}`)
     const domains = ['https://nuzlocke.vercel.app', 'https://nuzlocke.app',]

     const messageHandler = event => {
       log(`Message received`)
       if (!domains.includes(event.origin)) {
         log(`Invalid event origin: ${event.origin}`)
         return
       }

       const storage = window.localStorage
       const filtered = Object.fromEntries(
         Object
           .entries(storage)
           .filter(([key]) => key.startsWith('nuzlocke'))
       )

       const { action } = event.data
       if (action === 'cdls_get') {
         event.source.postMessage({
           action: 'cdls_data',
           data: filtered
         }, '*')
       }
     }

     log(`Iframe mounted - Posting ready message`)
     window.addEventListener('message', messageHandler, false)
     top.postMessage({ action: 'cdls_ready' }, '*')
    </script>
  </head>
  <body></body>
</html>
